{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "message.schema.json",
  "title": "Message (Provider)",
  "description": "Internal message format used by the agent loop and passed to provider-specific converters. Distinct from ChatMessage (which is the persisted format).",
  "type": "object",
  "required": ["role", "content"],
  "properties": {
    "role": {
      "type": "string",
      "enum": ["user", "assistant", "tool"],
      "description": "Message role for LLM API"
    },
    "content": {
      "type": "string",
      "description": "Text content of the message"
    },
    "tool_call_id": {
      "type": "string",
      "description": "Tool call ID for OpenAI-style tool result messages"
    },
    "tool_name": {
      "type": "string",
      "description": "Tool name for Ollama-style tool result messages"
    },
    "tool_calls": {
      "type": "array",
      "description": "Tool calls made by assistant (OpenAI format)",
      "items": { "$ref": "tool-call.schema.json#/$defs/ToolCall" }
    },
    "tool_results": {
      "type": "array",
      "description": "Tool results for Anthropic-style messages",
      "items": {
        "type": "object",
        "required": ["type", "tool_use_id", "content"],
        "properties": {
          "type": { "const": "tool_result" },
          "tool_use_id": { "type": "string" },
          "tool_name": { "type": "string" },
          "content": {
            "description": "String or array of content blocks (text/image)",
            "oneOf": [
              { "type": "string" },
              {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": { "type": { "type": "string" } },
                  "additionalProperties": true
                }
              }
            ]
          }
        }
      }
    },
    "thinking": {
      "type": "string",
      "description": "Accumulated thinking/reasoning text from model. Sources: Anthropic extended thinking (thinking blocks), OpenAI reasoning_content, Gemini thought parts, Ollama <think> tags. Stored as plain text for display; structured thinking blocks with signatures are in content_blocks."
    },
    "content_blocks": {
      "type": "array",
      "description": "Full structured content blocks from assistant responses. Preserves thinking blocks (with signature for multi-turn verification), text blocks, and tool_use blocks. Passed back to the API in subsequent turns.",
      "items": {
        "oneOf": [
          {
            "type": "object",
            "description": "Thinking block — model's chain-of-thought reasoning",
            "required": ["type", "thinking"],
            "properties": {
              "type": { "const": "thinking" },
              "thinking": { "type": "string", "description": "Thinking/reasoning text (summary for Claude 4 models)" },
              "signature": { "type": "string", "description": "Encrypted full thinking content for multi-turn verification. Must be passed back unmodified." }
            }
          },
          {
            "type": "object",
            "description": "Redacted thinking block — filtered thinking content",
            "required": ["type", "data"],
            "properties": {
              "type": { "const": "redacted_thinking" },
              "data": { "type": "string", "description": "Encrypted redacted content" }
            }
          },
          {
            "type": "object",
            "description": "Text block — model's text response",
            "required": ["type", "text"],
            "properties": {
              "type": { "const": "text" },
              "text": { "type": "string" }
            }
          },
          {
            "type": "object",
            "description": "Tool use block — model requests tool execution",
            "required": ["type", "id", "name", "input"],
            "properties": {
              "type": { "const": "tool_use" },
              "id": { "type": "string" },
              "name": { "type": "string" },
              "input": { "type": "object", "additionalProperties": true }
            }
          },
          {
            "type": "object",
            "description": "Other provider-specific block types",
            "properties": { "type": { "type": "string" } },
            "additionalProperties": true
          }
        ]
      }
    }
  }
}
